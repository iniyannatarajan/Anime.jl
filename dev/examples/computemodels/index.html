<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Compute instrument models Â· Anime.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://iniyannatarajan.github.io/Anime.jl/examples/computemodels/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="Anime.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Anime.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../install/">Installation</a></li><li><a class="tocitem" href="../../components/">Components</a></li><li><a class="tocitem" href="../../instrumentmodels/">Instrument Models</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../createdataset/">Creating data sets</a></li><li><a class="tocitem" href="../readdataset/">Read/write MS</a></li><li><a class="tocitem" href="../computecoherency/">Compute coherency matrix</a></li><li class="is-active"><a class="tocitem" href>Compute instrument models</a><ul class="internal"><li><a class="tocitem" href="#Atmospheric-models"><span>Atmospheric models</span></a></li><li><a class="tocitem" href="#Primary-beam-response"><span>Primary beam response</span></a></li><li><a class="tocitem" href="#Instrumental-polarization"><span>Instrumental polarization</span></a></li><li><a class="tocitem" href="#Receiver-gains"><span>Receiver gains</span></a></li></ul></li><li><a class="tocitem" href="../generatesyntheticdata/">Generating synthetic data sets</a></li></ul></li><li><a class="tocitem" href="../../api/">Anime API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Compute instrument models</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Compute instrument models</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/iniyannatarajan/Anime.jl/blob/main/examples/computemodels.jl#" title="Edit on GitHub"><span class="docs-icon fab">ï‚›</span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Compute-instrument-models"><a class="docs-heading-anchor" href="#Compute-instrument-models">Compute instrument models</a><a id="Compute-instrument-models-1"></a><a class="docs-heading-anchor-permalink" href="#Compute-instrument-models" title="Permalink"></a></h1><p>The primary goal of <code>Anime</code> is to generate instrument models tailored to specific observations. The models are optionally stored in HDF5 format. Basic plotting functions are also provided to visualize the models. The following example demonstrates how to compute and visualize the models.</p><p>Load necessary modules:</p><pre><code class="language-julia hljs">using Anime</code></pre><pre><code class="language-julia hljs">using HDF5
using CairoMakie</code></pre><p>In all the following examples, replace <code>relativepath</code> with the path to the source code of <code>Anime.jl</code> which contains sample input files under <code>inputs/</code> and sample pre-created data sets and instrument models under <code>test/</code>.</p><p>We will use two data sets to illustrate instrument model generation â€“ a single-channel data set and a multi-frequency data set. We first prepare config Dicts for use with the two data sets.</p><pre><code class="language-julia hljs">obsconfig = Dict()

obsconfig[&quot;msname&quot;] = joinpath(relativepath, &quot;test&quot;, &quot;data&quot;, &quot;ehtuvf.ms&quot;)
obsconfig[&quot;stations&quot;] = joinpath(relativepath, &quot;inputs&quot;, &quot;eht_2017.stations&quot;)
obsconfig[&quot;corruptseed&quot;] = 456
obsconfig[&quot;troposphere&quot;] = Dict()
obsconfig[&quot;troposphere&quot;][&quot;tropseed&quot;] = 54364
obsconfig[&quot;troposphere&quot;][&quot;wetonly&quot;] = false
obsconfig[&quot;correff&quot;] = 0.88
obsconfig[&quot;troposphere&quot;][&quot;attenuate&quot;] = true
obsconfig[&quot;troposphere&quot;][&quot;skynoise&quot;] = true
obsconfig[&quot;troposphere&quot;][&quot;meandelays&quot;] = true
obsconfig[&quot;troposphere&quot;][&quot;turbulence&quot;] = true
obsconfig[&quot;instrumentalpolarization&quot;] = Dict()
obsconfig[&quot;instrumentalpolarization&quot;][&quot;visibilityframe&quot;] = &quot;sky&quot;
obsconfig[&quot;instrumentalpolarization&quot;][&quot;mode&quot;] = &quot;gp&quot;
obsconfig[&quot;pointing&quot;] = Dict()
obsconfig[&quot;pointing&quot;][&quot;interval&quot;] = 5.0
obsconfig[&quot;pointing&quot;][&quot;scale&quot;] = 2.0
obsconfig[&quot;pointing&quot;][&quot;mode&quot;] = &quot;gp&quot;
obsconfig[&quot;stationgains&quot;] = Dict()
obsconfig[&quot;stationgains&quot;][&quot;mode&quot;] = &quot;gp&quot;
obsconfig[&quot;bandpass&quot;] = Dict()
obsconfig[&quot;bandpass&quot;][&quot;bandpassfile&quot;] = joinpath(relativepath, &quot;test&quot;, &quot;data&quot;, &quot;eht_2017.bandpass&quot;)

singlechannelms = readms(joinpath(relativepath, &quot;test&quot;, &quot;data&quot;, &quot;ehtuvf.ms&quot;)) # single-channel MS
multichannelms = readms(joinpath(relativepath, &quot;test&quot;, &quot;data&quot;, &quot;eht1.ms&quot;)) # multi-frequency MS

stationinfo = readstationinfo(obsconfig[&quot;stations&quot;], delim=&quot;,&quot;, ignorerepeated=false) # read station info file
bandpassinfo = readbandpassinfo(obsconfig[&quot;bandpass&quot;][&quot;bandpassfile&quot;], delim=&quot;,&quot;, ignorerepeated=false); # read bandpass info file</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Load data from MS ðŸ™†
[ Info: Load data from MS ðŸ™†</code></pre><h2 id="Atmospheric-models"><a class="docs-heading-anchor" href="#Atmospheric-models">Atmospheric models</a><a id="Atmospheric-models-1"></a><a class="docs-heading-anchor-permalink" href="#Atmospheric-models" title="Permalink"></a></h2><p>At mm-wavelengths (230 GHz), the troposphere has significant effects on signal propagation. <code>Anime</code> re-implements in <code>Julia</code> all the tropospheric effects simulated by <code>MEQSv2</code><sup class="footnote-reference"><a id="citeref-1" href="#footnote-1">[1]</a></sup>. The advantage here is that apart from being faster and not requiring a regular grid of complex visibilities in baseline-time space, they can be called from other imaging and calibration packages when necessary.</p><p>The function <a href="../../api/#Anime.troposphere!"><code>troposphere!</code></a> computes various tropospheric effects based on the flags set when <code>readms</code> is called.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>The external program <code>AATM</code> is requred to generate quantities related to tropospheric absorption and dispersion. Here we</p></div></div><p>pass pre-existing CSV output from <code>AATM</code> to <code>absorptionfile</code> and <code>dispersivefile</code>. The elevation angles of all antennas during the course of the observation can also be preloaded when <code>casatools</code> are unavailable to generate them from scratch.</p><pre><code class="language-julia hljs">h5file = &quot;sample.h5&quot;
absorptionfile = joinpath(relativepath, &quot;test&quot;, &quot;data&quot;, &quot;absorption1.csv&quot;)
dispersivefile = joinpath(relativepath, &quot;test&quot;, &quot;data&quot;, &quot;dispersive1.csv&quot;)
elevfile = joinpath(relativepath, &quot;test&quot;, &quot;data&quot;, &quot;insmodeluvf.h5&quot;)

troposphere!(singlechannelms, stationinfo, obsconfig, h5file, absorptionfile=absorptionfile, dispersivefile=dispersivefile, elevfile=elevfile)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Computing tropospheric effects...
[ Info: Compute absorption by and dispersive delay in the troposphere using ATM ðŸ™†
[ Info: Apply attenuation due to opacity ðŸ™†
[ Info: Apply tropospheric noise ðŸ™†
[ Info: Apply mean delays due to troposphere ðŸ™†
[ Info: Introduce turbulence in the troposphere ðŸ™†
[ Info: Compute and apply tropospheric model ðŸ™†</code></pre><p>This computes the delays introduced by the mean and turbulent components of the troposphere, along with attenuation due to opacity and increase in system noise.</p><p><code>Anime</code> provides plotting functions that help visualize these models. In the following, the gaps in the plotted curves signify lags between two observing scans.</p><p>For example, to plot the elevation angles by station we can just do</p><pre><code class="language-julia hljs">plotelevationangle(elevfile, singlechannelms.scanno, singlechannelms.times, stationinfo.station)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Plotting elevation angles by station...
[ Info: Plotted elevation angles ðŸ™†</code></pre><p><img src="../ElevationAngle_vs_time.png" alt="Elevation angle"/></p><p>The transmission values computed can be plotted using</p><pre><code class="language-julia hljs">plottransmission(h5file, stationinfo.station, singlechannelms.times, singlechannelms.chanfreqvec)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Plotting station-based transmission values
[ Info: Plotted tropospheric transmission ðŸ™†</code></pre><p><img src="../Transmission_vs_time.png" alt="Transmission"/> Since this is a channel-averaged data set, the frequency-dependent transmission reduces to a single curve per station.</p><p>The delays due to the mean component of the troposphere can be plotted as follows:</p><pre><code class="language-julia hljs">plotmeandelays(h5file, stationinfo.station, singlechannelms.times, singlechannelms.chanfreqvec)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Plotting station-based transmission values
[ Info: Plotted mean delays ðŸ™†</code></pre><p><img src="../MeanDelays_vs_time.png" alt="Mean Delays"/></p><h2 id="Primary-beam-response"><a class="docs-heading-anchor" href="#Primary-beam-response">Primary beam response</a><a id="Primary-beam-response-1"></a><a class="docs-heading-anchor-permalink" href="#Primary-beam-response" title="Permalink"></a></h2><p>We model the effects of antenna pointing offsets caused by various mechanical or electronic effects. The size of the primary beam affects how much the errors in antenna pointing attenuate the complex visibilities. <code>Anime</code> models the pointing offsets as Gaussian processes which are useful for modelling smooth variations in pointing over time.</p><p>The function <a href="../../api/#Anime.pointing!"><code>pointing!</code></a> is used to compute and apply pointing models to data.</p><pre><code class="language-julia hljs">pointing!(singlechannelms, stationinfo, obsconfig, h5file=h5file)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Computing pointing errors...
â”Œ Warning: Pointing interval (5.0) &lt; integration time (10.0)! Setting pointing interval to 10.0 s ...
â”” @ Main.Anime ~/work/Anime.jl/Anime.jl/src/beammodels/beammodels.jl:70
[ Info: Generating new mispointings every 10.0 seconds...
[ Info: Compute and apply pointing model ðŸ™†</code></pre><p>Note that this method is a shorthand for another method with multiple arguments that provides more fine-grained control over the input parameters.</p><p>We now plot the pointing model generated:</p><pre><code class="language-julia hljs">plotpointingerrors(h5file, singlechannelms.scanno, stationinfo.station)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Plotting pointing errors...
[ Info: Plotted pointing offsets and amplitude errors ðŸ™†</code></pre><p><img src="../Pointing_offsets_amplitude_errors_vs_time.png" alt="Pointing errors"/> Mispointings of station LM (Large Millimeter Telescope, Mexico), the largest dish in the array, result in the largest attenuation of amplitude.</p><h2 id="Instrumental-polarization"><a class="docs-heading-anchor" href="#Instrumental-polarization">Instrumental polarization</a><a id="Instrumental-polarization-1"></a><a class="docs-heading-anchor-permalink" href="#Instrumental-polarization" title="Permalink"></a></h2><p>The feed receptors are designed to be sensitive to orthogonal polarization states in either circular or linear bases. Due to imperfections in the feed (either mechanical or electronic), the orthogonal measurements &quot;leak&quot; into the other feed, thereby giving rise to a multiplicative Jones matrix with small non-zero off-diagonal terms. This <em>feed error</em> or <em>leakage</em> matrix is also known as the D-Jones term. In practice, this term can vary with frequency.</p><p><code>Anime</code> generates smoothly varying frequency-dependent D-terms using Gaussian processes, taking a location and a scale parameter that determine the amount of leakage at each station. If the user requests to apply instrumental polarization to visibilities, they can be written out either in sky frame or antenna frame i.e., with or without parallactic angle de-rotation respectively.</p><pre><code class="language-julia hljs">inh5file = joinpath(relativepath, &quot;test&quot;, &quot;data&quot;, &quot;insmodeluvf.h5&quot;)
instrumentalpolarization!(singlechannelms, stationinfo, obsconfig, h5file=h5file, elevfile=inh5file, parangfile=inh5file)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Computing polarization models...
[ Info: Applying instrumental polarization and rotating back to sky frame ...
[ Info: Compute and apply polarization models ðŸ™†</code></pre><pre><code class="language-julia hljs">plotparallacticangle(h5file, singlechannelms.scanno, singlechannelms.times, stationinfo.station)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Plotting elevation angles by station...
[ Info: Plotted parallactic angles ðŸ™†</code></pre><p><img src="../ParallacticAngle_vs_time.png" alt="Parallactic angle"/></p><pre><code class="language-julia hljs">plotdterms(h5file, stationinfo.station, multichannelms.chanfreqvec)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Plotting cross-hand instrumental leakage (D-terms) by station...
[ Info: Plotted D-terms ðŸ™†</code></pre><p><img src="../Dterms_vs_frequency.png" alt="D-terms"/> We show the D-terms for the multi-channel MS for ease of visualization.</p><h2 id="Receiver-gains"><a class="docs-heading-anchor" href="#Receiver-gains">Receiver gains</a><a id="Receiver-gains-1"></a><a class="docs-heading-anchor-permalink" href="#Receiver-gains" title="Permalink"></a></h2><p>Temporal variations in complex receiver gainsfor both feeds are modelled independently. The amplitudes are modelled using a Gaussian process kernel (such as SE) while the phases are modelled using a Wiener process with a given location and scale parameters.</p><p>We use an observation with only 2 scans to illustrate this better.</p><pre><code class="language-julia hljs">stationgains!(multichannelms, stationinfo, obsconfig, h5file=h5file)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Computing station gains...
[ Info: Compute and apply station gains ðŸ™†</code></pre><pre><code class="language-julia hljs">plotstationgains(h5file, multichannelms.scanno, multichannelms.times, multichannelms.exposure, stationinfo.station)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Plotting station gains against time...
[ Info: Plotted station gains ðŸ™†</code></pre><p><img src="../StationGains_vs_time.png" alt="Station gains"/></p><p>Also there is a complex bandpass gain variation that is modelled by using representative bandpass amplitude values at certain frequencies across the bandwidth and interpolated for the missing frequency channels.</p><pre><code class="language-julia hljs">bandpass!(multichannelms, stationinfo, bandpassinfo, obsconfig, h5file=h5file)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Computing bandpass...
[ Info: Compute and apply bandpass gains ðŸ™†</code></pre><pre><code class="language-julia hljs">plotbandpass(h5file, stationinfo.station, multichannelms.chanfreqvec)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Plotting bandpass gains against time...
[ Info: Plotted bandpass ðŸ™†</code></pre><p><img src="../BandpassGains_vs_frequency.png" alt="Bandpass"/></p><h3 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h3><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-1"><a class="tag is-link" href="#citeref-1">1</a>Natarajan I. et al. MeqSilhouette v2 (2022) <a href="https://academic.oup.com/mnras/article/512/1/490/6537429">MNRAS</a></li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../computecoherency/">Â« Compute coherency matrix</a><a class="docs-footer-nextpage" href="../generatesyntheticdata/">Generating synthetic data sets Â»</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Wednesday 15 May 2024 00:40">Wednesday 15 May 2024</span>. Using Julia version 1.10.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
